# PAM
## Цель
Рассмотреть механизмы авторизации и аутентификации;
Узнать какие бывают права у пользовталей;
Управлять правами с помощью sudo, umask. sgid, suid и более сложными инструментами как PAM и ACL, PolicyKit.
## Описание:

- Запретить всем пользователям, кроме группы admin логин в выходные (суббота и воскресенье), без учета праздников
- ** Дать конкретному пользователю права работать с докером и возможность рестартить докер сервис
> В методичке описывается решение как пользователь ”day” - имеет удаленный доступ каждый день с 8 до 20; “night” - с 20 до 8; “friday” - в любое время, если сегодня пятница. 
> Это противоречит постановке первой задачи в описании, поэтому ниже будет описано решение с запретом всем пользователям кроме группы admin осуществлять вход в выходные дни

## Пошаговая инструкция выполнения домашнего задания:
### Подготовка пользователей
Командой useradd создадим пользователей user1, user2, user3, user4, user5.
Назначим всем для удоства одинаковый пароль командой passwd.
Создадим группу admin командой groupadd
Командой usermod -aG добавим user1, user2 и root в группу admin
```
[root@yarkozloff ~]# cat /etc/group | grep admin
admin:x:1006:user1,user2,root
```
Проверим вход под ними (я использую BitwiseSSH как ssh клиент):
```
[user1@yarkozloff ~]$ whoami
user1
[user1@yarkozloff ~]$ pwd
/home/user1
```
 ### Модуль pam_time
 Модуль pam_time позволяет достаточно гибко настроить доступ пользователя с учетом времени. Настройки данного модуля хранятся в файле /etc/security/time.conf.
 Добавим туда запись следующего формата:
sshd;*;!admin;Wk0000-2400
- sshd; - сервис, к которому применяется правило
- *; имя терминала, к которому применяется правило, тут можно было указать tty
- !admin; - группа пользователей к которым не применяется правило, то есть все кроме admin
- Wk0000-2400; - Время, когда правило носит разрешающий характер (Рабочие дни всё время) 

Теперь настроим PAM, так как по-умолчанию данный модуль не
подключен.
Для этого приведем файл /etc/pam.d/sshd к виду:
```
account    required     pam_nologin.so
account    required     pam_time.so
```
Всё настроено как и планировалось, но при проверке обнружились проблемы, оказалось, в 3 параметре /etc/security/time.conf нельзя задать локальную группу, только имя пользователя или сетевой группы (оказывается я не один такой https://serverfault.com/questions/1037366/linux-pam-time-with-groups). Можно перечислить всех пользователей через или, но это конечно не вариант.

### Модуль pam_exec
Еще один способ реализовать задачу это выполнить при подключении пользователя скрипт, в котором мы сами обработаем необходимую информацию.
Удалим из /etc/pam.d/sshd изменения из предыдущего этапа и
приведем его к следующему виду:
```
account    required     pam_nologin.so
account    required     pam_exec.so /usr/local/bin/test_login.sh
```
Мы добавили модуль pam_exec и, в качестве параметра, указали
скрипт, который осуществит необходимые проверки. Создадим сам
скрипт:
```
#!/bin/bash
username=$PAM_USER
if [ $(date +%a) = "Sat" ]  || [ $(date +%a) = "Sun" ]; then
  if getent group admin | grep -q "\b${username}\b"; then
        exit 0
      else
        exit 1
    fi
  else
    exit 1
fi
```
При запуске данного скрипта PAM-модулем будет передана переменная окружения PAM_USER, содержащая имя пользователя. Затем вычисляется день недели, если это суббота или воскресенье то проверяем вхождение пользователя в группу admin, при выполнении обоих условий возвращается 0, иначе 1.
Проверяем, ошибка при логине:
```
/usr/local/bin/test_login.sh failed: exit code 13
```
Проверяем скрипт, заменим exit на echo а переменную $PAM_USER на $1, выполняем - успех, то есть скрипт работаем верно. Проблема видимо при передаче параметра PAM_USER, идем в гугл:

